# AI Resume Generation Feature - Complete Rebuild Brief

**Date**: 2025-10-11
**Project**: ResumePair
**Scope**: Complete removal and rebuild of AI resume generation system
**Priority**: P0 - Critical (feature non-functional for 5+ days)

---

## Problem Statement

The AI resume generation feature is **completely broken** and must be rebuilt from scratch:

### Why Complete Rebuild is Required
1. **Fundamentally Broken Code**: Undefined variables causing crashes throughout (`libs/ai/resumeGenerator.ts:150` is just one example)
2. **Incomplete Output**: Rarely generates more than 2 sections, sometimes returns nothing at all
3. **No Architecture**: Implementation scattered across multiple files with no structure, patterns, or engineering principles
4. **Over-Engineered Validation**: Complicated schema with triple validation pipeline causing 60-80% data loss
5. **Poor Prompts**: Restrictive prompts that limit AI effectiveness and produce inconsistent results

**Cannot be fixed incrementally** - the architecture is fundamentally flawed and must be replaced.

### Desired State
User provides any combination of inputs (job description, PDF, personal info) → clicks "generate" → receives fully generated resume with all relevant sections populated → can apply to editor seamlessly.

---

## User Flows (Target Behavior)

### Flow 1: Traditional Editor (Working - Reference Only)
User fills text fields → live preview renders on right → autosave → done.

### Flow 2: AI Generation (BROKEN - COMPLETE REBUILD REQUIRED)
**Input Options** (must provide at least one):
- Job description text (50-8000 chars)
- PDF upload (max 10MB)
- Personal information (name, email, phone, location)

**Target Behavior** (new implementation):
1. User provides inputs
2. User clicks "Generate"
3. System sends data to Gemini 2.5 Flash
4. Gemini returns structured resume data matching our schema
5. Preview renders complete resume
6. User reviews and applies to editor

**Why Current Implementation Must Be Removed**:
- ❌ Fundamentally broken architecture (crashes, incomplete output)
- ❌ Scattered implementation with no clear patterns
- ❌ Over-complicated validation pipeline causing data loss
- ❌ Cannot be salvaged through incremental fixes

### Flow 3: Templates (Working - Reference Only)
Multiple templates available, user selects template, resume renders with chosen template.

---

## Technical Context

### Architecture Overview
```
User Input → API Route → Prompt Builder → Gemini API → Sanitization → Normalization → Validation → ResumeJson → ResumeData Adapter → Template Renderer → Preview
```

### Current Pipeline Issues
1. **Triple Validation**: Data validated 3 times (sanitize → normalize → validate) with 60-80% data loss
2. **Schema Mismatch**: AI uses ultra-permissive schema (`z.any().optional()`) but validation expects strict format
3. **Missing Defaults**: Required fields (settings, appearance) never generated by AI
4. **Silent Drops**: Invalid sections dropped without warnings
5. **Rigid Formats**: Date validation only accepts YYYY-MM-DD, rejects YYYY and YYYY-MM

### Files in Current Broken Implementation
- **AI Layer** (to be deleted/replaced): `libs/ai/resumeGenerator.ts`, `libs/ai/prompts.ts`, `libs/ai/provider.ts`
- **API** (to be rewritten): `app/api/v1/ai/unified/route.ts`
- **Schemas** (to be redesigned): `libs/validation/resume.ts`, `libs/reactive-artboard/schema/*`
- **Data Pipeline** (to be simplified): `libs/sanitization/resume.ts`, `libs/repositories/normalizers.ts`
- **Adapters** (keep, may need updates): `libs/reactive-artboard/adapters/resumeData.ts`
- **Frontend** (keep, may need updates): `components/ai/UnifiedAITool.tsx`, `stores/unifiedAIStore.ts`

**Note**: Template system and preview rendering work correctly and should be preserved.

---

## Scope Intent

This context pack includes **everything directly and indirectly touching** the AI resume generation feature:

### Included
✅ Complete AI integration layer (generation, prompts, provider)
✅ All schema definitions (validation, template, database)
✅ Full data processing pipeline (sanitization, normalization, adapters)
✅ API routes and middleware
✅ Frontend components and state management
✅ Template system and preview rendering
✅ Sample data and test scripts
✅ Supporting infrastructure (rate limiting, quota tracking)
✅ Relevant documentation from ai_docs/

### Excluded
❌ Cover letter generation (out of scope for now)
❌ Unrelated features (scoring, export, auth)
❌ Marketing site and blog
❌ Database migrations (schema is stable)

---

## Evidence of Broken Implementation

### Example 1: Fundamental Architecture Flaw
**Location**: `libs/ai/resumeGenerator.ts:150`
```typescript
// Line 150 - Example of broken code that will be removed
return {
  resume,
  raw,  // ❌ Variable 'raw' is not defined
  usage: usageSummary,
  warnings: [],
}
```
**Note**: This is just one symptom of the deeper architectural issues. The entire file needs replacement.

### Example 2: Schema Mismatch
```typescript
// PERMISSIVE (AI generation)
ResumeGenerativeSchema = z.object({
  profile: z.any().optional(),
  work: z.any().optional(),
  // ... all fields z.any().optional()
}).passthrough()

// STRICT (validation)
ResumeJsonSchema = z.object({
  profile: ProfileSchema,  // email REQUIRED, must be valid
  work: z.array(WorkExperienceSchema).optional(),  // strict dates
  settings: ResumeSettingsSchema,  // REQUIRED (never generated)
})
```

### Data Loss Example
```typescript
// normalizers.ts:119
if (!company || !role || !startDate) return null  // ⚠️ Silent drop
```

### Recent Commits (Git Status)
```
M app/api/v1/ai/unified/route.ts
M libs/ai/prompts.ts
M libs/reactive-artboard/renderer/ArtboardRenderer.tsx
D libs/validation/resume-generation.ts
?? libs/ai/resumeGenerator.ts
?? libs/sanitization/
```

---

## Constraints

### Performance
- **API timeout**: 60s max (Edge runtime limit)
- **Preview latency**: <120ms p95 (user perception budget)
- **Token cost**: <$0.001 per generation (Gemini 2.5 Flash pricing)

### Compatibility
- **Framework**: Next.js 14, React 18, TypeScript (strict mode)
- **AI Provider**: Google Gemini 2.5 Flash (no model changes)
- **State**: Zustand + zundo (undo/redo required)
- **UI**: shadcn/ui + Tailwind CSS (no new libraries)

### Security
- **RLS**: All database queries user-scoped
- **Quota**: 100 operations per 24-hour period
- **Sanitization**: All HTML content must be sanitized (XSS prevention)
- **Validation**: Email, URL, phone validation required

### Platform
- **Deployment**: Vercel Edge + Node runtimes
- **Database**: Supabase Postgres
- **Auth**: Supabase Auth (session-based)

---

## Tech Stack Reference

**Required Stack** (do NOT deviate):

**Core**:
- Next.js 14 (App Router, React Server Components)
- React 18
- TypeScript 5.4+ (strict mode, no `any`)

**AI & Validation**:
- Vercel AI SDK (`ai` package) with `generateObject()`
- Google Gemini 2.5 Flash (`@ai-sdk/google`)
- Zod for schema validation

**State Management**:
- Zustand for client state
- `zundo` for undo/redo

**Database & Auth**:
- Supabase client (`@supabase/supabase-js`)
- Supabase SSR (`@supabase/ssr`)
- Row-level security (RLS) enforced

**UI & Styling**:
- shadcn/ui components
- Tailwind CSS (with custom config)
- Lucide React icons ONLY
- Radix UI primitives (via shadcn)

**Utilities**:
- lodash (selective imports)
- DOMPurify for HTML sanitization
- date-fns for date formatting

**API Patterns** (mandatory):
```typescript
// Always use these wrappers
import { withAuth, apiSuccess, apiError } from '@/libs/api-utils'

export const POST = withAuth(async (req, { user }) => {
  // Your logic
  return apiSuccess(data, "Success message")
})
```

**Conventions**:
- Server-only code: Repository pattern with DI
- Client-only code: Zustand stores
- Never use `any`, always explicit types
- Design tokens: `--app-*` for app, `--doc-*` for templates
- No empty catch blocks

---

## What to Return

**Deliverable**: Complete implementation plan + new code

### Required Outputs
1. **Implementation Plan** (markdown document):
   - New architecture design (clean, simple pipeline)
   - New schema design (single source of truth, progressive validation)
   - Prompt engineering strategy (few-shot examples, clear instructions)
   - Data flow diagrams (new implementation)
   - File structure (new files to create)
   - Migration strategy (what to delete, what to create fresh)

2. **New Implementation Code** (complete files, not patches):
   - New AI generation module (complete replacement for resumeGenerator.ts)
   - New schema definitions (clean, validated approach)
   - New prompts (with examples, simplified)
   - New validation pipeline (single-pass, with warnings)
   - New error handling (comprehensive, user-friendly)
   - Updated UI components (if needed for new flow)

3. **Testing Strategy**:
   - Unit tests for schemas (permissive input, strict output)
   - Integration tests for full pipeline
   - E2E test for API route
   - Test cases with real job descriptions

### Formatting Requirements
- **New Files**: Complete file contents with clear headers showing file path
- **File paths**: Absolute from project root
- **Comments**: Explain all non-obvious logic and design decisions
- **Code style**: Follow existing project conventions (TypeScript strict, no `any`)
- **Implementation strategy**:
  1. List files to DELETE from existing implementation
  2. Provide complete NEW file implementations
  3. List files to UPDATE (with complete new content, not patches)

### Success Criteria
✅ All generations complete without crashes
✅ 90%+ success rate (valid ResumeJson returned)
✅ 80%+ completeness rate (≥6 sections populated)
✅ Average 3-4 work experiences per resume
✅ Preview renders complete resume in <120ms
✅ No silent data loss (all drops logged as warnings)

---

## If You Need More

If additional context is required, specify:
- **Exact file paths** to add (e.g., `libs/exporters/pdfGenerator.ts`)
- **Specific sections** of existing files (e.g., "lines 50-100 of X")
- **Related functionality** not yet included (e.g., "cover letter prompts")

We will re-pack with expanded scope and deliver updated `pack.xml`.

---

## Key Design Principles (from ai_docs/standards/)

### Architecture
1. **Schema-driven**: One JSON powers everything
2. **Repository pattern**: Pure functions with dependency injection
3. **Layered boundaries**: Presentation → Application → Domain → Infrastructure
4. **Type safety**: Make invalid states unrepresentable

### Implementation
1. **TypeScript strict**: No `any`, explicit types
2. **API patterns**: Always use `withAuth`/`withApiHandler`
3. **Design tokens**: Two systems (`--app-*` vs `--doc-*`)
4. **No empty catch blocks**: Always log errors

### Data Flow
```
ResumeJson (database/API) → sanitize → normalize → ResumeData (adapter) → Template → Preview
```

### Template System
- Templates consume data from Zustand store (`useArtboardStore`)
- All section items MUST include `id` (string) and `visible` (boolean)
- HTML content MUST be sanitized before render (DOMPurify)
- Layout structure: `pages[columns[sections]]` (3D array)

---

## Context Pack Contents

This pack contains **78 files** organized into:
- Core AI generation code (7 files)
- Schemas and validation (15 files)
- Data processing pipeline (2 files)
- Frontend components (8 files)
- Preview and rendering (6 files)
- Template system (4 files + 13 section schemas)
- Adapters and mappers (4 files)
- Sample data and tests (3 files)
- Documentation (6 files)
- Configuration (3 files)

**Total**: Comprehensive coverage of all layers touching AI resume generation.

---

## Recommended Implementation Approach

### Phase 1: Clean Foundation
1. **Delete** existing broken implementation:
   - Remove `libs/ai/resumeGenerator.ts` entirely
   - Remove `libs/sanitization/resume.ts` (over-complicated)
   - Remove validation schemas with schema mismatch issues

2. **Create** new foundation:
   - New clean schema (single source of truth, no permissive/strict split)
   - New validation approach (progressive, with warnings not failures)
   - Simple, clear data flow

### Phase 2: Core AI Generation
1. **Build** new AI generation module from scratch:
   - Clean prompt construction (with few-shot examples)
   - Direct Gemini integration (no unnecessary layers)
   - Single-pass validation with comprehensive warnings
   - Clear error handling and user feedback

2. **Design principles**:
   - Simplicity over complexity
   - Fail gracefully with partial results
   - Log everything, fail nothing silently

### Phase 3: Integration & Testing
1. **Connect** to existing systems:
   - API route integration
   - Frontend component updates (if needed)
   - Preview system integration

2. **Validate** with real scenarios:
   - Test with 10+ real job descriptions
   - Measure success rate (target: 90%+)
   - Measure completeness (target: 6+ sections)
   - Ensure <120ms preview updates

### Phase 4: Polish & Reliability
1. **Enhance** user experience:
   - Preview before apply flow
   - Clear error messages
   - Retry mechanism
   - Loading states

2. **Production readiness**:
   - Comprehensive logging
   - Monitoring and alerting
   - Documentation for maintenance

---

**This brief is your single source of truth for rebuilding the AI resume generation feature.**
